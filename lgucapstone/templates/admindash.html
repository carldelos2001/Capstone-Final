<!DOCTYPE html>
<html lang="en">
<head>
  {% load static %}
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'style.css' %}">

  <title>Dashboard</title>
</head>
<body>
  
  <div class="container mt-5">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h1_upper">Ordinance and Resolution Dashboard</h1>
      <button class="btn btn-success" onclick="window.location.href='{% url 'add_ordinance_resolution' %}'">Add Ordinance/Resolution</button>
    </div>

    <!-- Search Box -->
    <div class="input-group mb-4">
      <input type="text" class="form-control" placeholder="Search Ordinance/Resolution" id="search-box">
      <button class="btn btn-primary" type="button" id="search-button">Search</button>
    </div>

    <!-- Charts Section -->
    <div class="row">
      <div class="col-md-6">
        <canvas id="barChart"></canvas>
      </div>
      <div class="col-md-6">
        <canvas id="pieChart" width="300" height="300"></canvas>
      </div>
    </div>

    <!-- Current Ordinances and Resolutions Section -->
    <div class="mt-5">
      <h2>Current Ordinances and Resolutions</h2>
      <div id="ordinances-list">
        {% for ordinance in ordinances %}
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">{{ ordinance.title }}</h5>
              <p class="card-text">{{ ordinance.description }}</p>
              <a href="{% url 'ordinance_detail' ordinance.id %}" class="btn btn-primary">View Details</a>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-app.js";
    import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAMwvUHsWFkTmJyfzuh4DxzOrMYEjcXHvI",
      authDomain: "lgucapstoneproject-b94fe.firebaseapp.com",
      databaseURL: "https://lgucapstoneproject-b94fe-default-rtdb.firebaseio.com",
      projectId: "lgucapstoneproject-b94fe",
      storageBucket: "lgucapstoneproject-b94fe.appspot.com",
      messagingSenderId: "984934888272",
      appId: "1:984934888272:web:e835b8e02ae708629a7255",
      measurementId: "G-F84YQS756S"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Function to parse the month from a date string (YYYY-MM-DD)
    function getMonthFromDate(dateStr) {
      const date = new Date(dateStr);
      return date.getMonth(); // Returns 0 for January, 1 for February, etc.
    }

    // Fetch and Update Bar Chart Data
function fetchBarChartData() {
  const ordinancesRef = ref(db, 'ordinances');
  const resolutionsRef = ref(db, 'resolutions');

  Promise.all([get(ordinancesRef), get(resolutionsRef)])
    .then(([ordinancesSnapshot, resolutionsSnapshot]) => {
      const ordinancesData = ordinancesSnapshot.val() || {};
      const resolutionsData = resolutionsSnapshot.val() || {};

      const ordinanceCounts = new Array(12).fill(0); // Initialize counts for ordinances by month
      const resolutionCounts = new Array(12).fill(0); // Initialize counts for resolutions by month

      // Process each ordinance and increment the count for the month it was approved
      Object.values(ordinancesData).forEach(ordinance => {
        const monthIndex = getMonthFromDate(ordinance.date_approved);
        ordinanceCounts[monthIndex]++;
      });

      // Process each resolution and increment the count for the month it was approved
      Object.values(resolutionsData).forEach(resolution => {
        const monthIndex = getMonthFromDate(resolution.date_approved);
        resolutionCounts[monthIndex]++;
      });

      // Update Bar Chart with both ordinances and resolutions data
      barChart.data.datasets[0].data = ordinanceCounts; // Update the ordinances dataset
      barChart.data.datasets[1].data = resolutionCounts; // Update the resolutions dataset
      barChart.update();
    })
    .catch(error => {
      console.error('Error fetching bar chart data: ', error);
    });
}

    // Fetch and Update Pie Chart Data
    function fetchPieChartData() {
      const ordinancesRef = ref(db, 'ordinances');
      const resolutionsRef = ref(db, 'resolutions');

      Promise.all([get(ordinancesRef), get(resolutionsRef)])
        .then(([ordinancesSnapshot, resolutionsSnapshot]) => {
          const ordinancesData = ordinancesSnapshot.val() || {};
          const resolutionsData = resolutionsSnapshot.val() || {};

          // Count ordinances and resolutions
          const ordinanceCount = Object.keys(ordinancesData).length;
          const resolutionCount = Object.keys(resolutionsData).length;

          // Update Pie Chart
          pieChart.data.datasets[0].data = [ordinanceCount, resolutionCount];
          pieChart.update();
        })
        .catch(error => {
          console.error('Error fetching pie chart data: ', error);
        });
    }

    // Fetch Chart Data on Page Load
    document.addEventListener('DOMContentLoaded', function () {
      fetchBarChartData();
      fetchPieChartData();
    });
  </script>

  <!-- Chart.js Script -->
  <script>
    // Bar Chart
    const barChartContext = document.getElementById('barChart').getContext('2d');
    const barChart = new Chart(barChartContext, {
      type: 'bar',
      data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'June', 'July', 'Aug', 'Sept', 'Oct', 'Nov', 'Dec'],
        datasets: [
          {
            label: 'Ordinances',
            data: [], // Data will be updated dynamically
            backgroundColor: '#52AE77FF', 
            borderColor: '#52AE77FF',
            borderWidth: 1
          },
          {
            label: 'Resolutions',
            data: [], // Data will be updated dynamically
            backgroundColor: '#009DCF', 
            borderColor: '#009DCF',
            borderWidth: 1
          }
        ]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });

    // Pie Chart 
    const pieChartContext = document.getElementById('pieChart').getContext('2d');
    const pieChart = new Chart(pieChartContext, {
      type: 'doughnut',
      data: {
        labels: ['Ordinance', 'Resolution'],
        datasets: [
          {
            label: 'Published',
            data: [], // Data will be updated dynamically
            backgroundColor: [
              '#52AE77FF', 
              '#009DCF'       
            ],
            borderColor: [
              '#52AE77FF', 
              '#009DCF'       
            ],
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        cutout: '80%',  
        plugins: {
          legend: {
            position: 'bottom', 
          }
        }
      }
    });
</script>

</body>
</html>
