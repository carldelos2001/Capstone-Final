<!DOCTYPE html>
<html lang="en">
<head>
  {% load static %}
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'style.css' %}">
  <link rel="icon" type="image/jpeg" href="{% static 'fav_argao.png'%}">
  <title>Session Notice</title>
  <style>
    @font-face {
      font-family: "Poppins";
      src: url("{% static 'fonts/Poppins-Regular.ttf' %}") format("truetype");
    }

    @font-face {
      font-family: "Poppins";
      src: url("{% static 'fonts/Poppins-Bold.ttf' %}") format("truetype");
      font-weight: bold;
    }

    body {
      font-family: "Poppins", sans-serif;
      font-size: 1rem;
      color: black;
    }
    .btn-secondary {
      background-color: #4a9d6d;
      border-color: #4a9d6d;
    }
    .btn-secondary:hover {
      background-color: #337a52;
      border-color: #337a52;
    }
    .btn-secondary:focus {
      background-color: #337a52;
      border-color: #337a52;
    }
    .btn-secondary:active {
      background-color: #337a52;
      border-color: #337a52;
    }
    .btn-primary{
      background-color: #4a9d6d;
      border: #4a9d6d;
    }
    .btn-primary:hover{
      background-color: #337a52;
      border: #337a52;
    }
    .btn-success{
      background-color: #4a9d6d;
      border: #4a9d6d;
    }
    .btn-success:hover{
      background-color: #337a52;
      border: #337a52;
    }
    .sidebar-footer {
      margin-top: auto;
      
      border-top: 1px solid #ddd;
    }

    .sidebar-footer #welcomeMessage {
      
      margin-bottom: 10px;
    }
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 250px;
      background-color: #f8f9fa;
      padding-top: 20px;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
    }
    
    .sidebar .logo {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .sidebar .logo img {
      width: 100px;
      border-radius: 50%;
    }
    
    .sidebar .nav-item {
      padding: 15px 20px;
      text-align: center;
      border-bottom: 1px solid #ddd;
    }
    
    .sidebar .nav-item:hover {
      background-color: #e9ecef;
      cursor: pointer;
    }
    
    .sidebar {
      overflow-y: auto;
      max-height: 100vh;
    }

    .sidebar::-webkit-scrollbar {
      width: 5px;
    }

    .sidebar::-webkit-scrollbar-thumb {
      background-color: #888;
      border-radius: 5px;
    }

    .sidebar::-webkit-scrollbar-thumb:hover {
      background-color: #555;
    }

    .main-content {
      padding: 20px;
    }
    
    .user-profile {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      z-index: 10;
    }
    
    .user-profile img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }

    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* Add error handling styles */
    .error-message {
      color: #dc3545;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #dc3545;
      border-radius: 4px;
      display: none;
    }

    .error-message.show {
      display: block;
    }
  </style>
  <style>
    /* Add this style for the scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* Add this style to limit the title content */
    .truncate-title {
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Sidebar toggle styles */
    .sidebar {
      transition: 0.3s;
      width: 250px;
      position: fixed;
      height: 100%;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 0;
    }

    .sidebar.collapsed {
      width: 60px;
    }

    .sidebar.collapsed .nav-item span,
    .sidebar.collapsed .sidebar-footer span {
      display: none;
    }

    .sidebar.collapsed .logo img {
      width: 40px;
      height: 40px;
      margin-top: 40px;
    }

    .burger-menu {
      display: none;
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 1001;
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
    }

    .burger-menu .bar {
      width: 25px;
      height: 3px;
      background-color: #333;
      margin: 4px 0;
      transition: 0.3s;
      display: block;
    }

    .sidebar.collapsed + .main-content {
      margin-left: 60px;
    }

    .main-content {
      margin-left: 250px;
      transition: 0.3s;
    }

    /* Close button style */
    .close-sidebar {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #333;
      display: block;
    }

    .sidebar.collapsed .close-sidebar {
      display: none;
    }

    /* Add styles for nav-item icons */
    .nav-item {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      width: 100%;
      padding: 10px 20px;
      cursor: pointer;
    }

    .nav-item img {
      margin-right: 10px;
      width: 20px;
      height: 20px;
      vertical-align: middle;
    }

    .sidebar-footer {
      
      align-items: left;
      justify-content: flex-start;
      width: 100%;
      
    }

    .sidebar-footer img {
      margin-right: 10px;
      width: 20px;
      height: 20px;
      vertical-align: middle;
    }

    @media (max-width: 768px) {
      .burger-menu {
        display: block;
      }
      
      .sidebar {
        transform: translateX(-250px);
      }

      .sidebar.collapsed {
        transform: translateX(-60px);
      }

      .sidebar.active {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }
    }
  </style>
  <!-- Add error handling script -->
  <script>
    function handleError(error) {
      console.error('Error:', error);
      const errorDiv = document.getElementById('errorMessage');
      if (errorDiv) {
        errorDiv.textContent = 'An error occurred. Please try again later.';
        errorDiv.classList.add('show');
        setTimeout(() => {
          errorDiv.classList.remove('show');
        }, 5000);
      }
    }

    window.onerror = function(msg, url, line) {
      handleError(`${msg} at ${url}:${line}`);
      return false;
    };
  </script>
</head>
<body>
  

  <!-- Burger Menu Button -->
  <button class="burger-menu" onclick="toggleSidebar()">
    <span class="bar"></span>
    <span class="bar"></span>
    <span class="bar"></span>
  </button>
  
  <!-- Sidebar -->
  <div class="sidebar">
    <!-- Close Button -->
    <button class="close-sidebar" onclick="toggleSidebar()">Ã—</button>
    
    <div class="logo">
      <img src="{% static 'argao_logo.jpg' %}" alt="Logo">
    </div>
    <div class="nav-item" onclick="window.location.href='/admin_dash'">
      <img src="{% static 'dashboard.svg' %}" alt="Dashboard">
      <span>Dashboard</span>
    </div>
    <div class="nav-item" onclick="window.location.href='/admin_services'">
      <img src="{% static 'information.svg' %}" alt="Info">
      <span>Information Bulletin</span>
    </div>
    <div class="nav-item" onclick="window.location.href='/admin_report'">
      <img src="{% static 'report.svg' %}" alt="Report">
      <span>Reports</span>
    </div>
    <div class="nav-item" onclick="window.location.href='/admin_staff_account'">
      <img src="{% static 'account.svg' %}" alt="Staff">
      <span style="margin-right: 70px;">Staff Account Management</span>
    </div>
    <div class="nav-item" onclick="window.location.href='/admin_feedback'">
      <img src="{% static 'feedback.svg' %}" alt="Feedback">
      <span>Feedbacks</span>
    </div>
    <div class="nav-item" onclick="window.location.href='/admin_notice'">
      <img src="{% static 'notice.svg' %}" alt="Notice">
      <span>Session Notice</span>
    </div>
    <div class="nav-item" onclick="window.location.href='/admin_attendance'">
      <img src="{% static 'attendance.svg' %}" alt="Attendance">
      <span>Attendance</span>
    </div>
    <div class="nav-item" onclick="window.location.href='/admin_minutes'">
      <img src="{% static 'minutes.png' %}" alt="Minutes">
      <span>Minutes Maker</span>
    </div>
    <div class="nav-item" onclick="window.location.href='/admin_board'">
      <img src="{% static 'announcement.svg' %}" alt="Announcement">
      <span>Announcement Board</span>
    </div>

    <div class="sidebar-footer">
      <span id="welcomeMessage" class="nav-item">
        
        Admin: <span id="userFirstName"></span>
      </span>
      
      <div class="nav-item" onclick="logout()">
        <img src="{% static 'logout.svg' %}" alt="Logout">
        <span >Log Out</span>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content" style="margin-left: 250px;">
    <div class="container mt-4">
      <h2>Session Notice</h2>
      
      <!-- Notice Form -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="mb-3">
            <label for="minutesNo" class="form-label">Minutes No.</label>
            <input type="text" class="form-control" id="minutesNo" placeholder="Refresh Page to Auto Generate" readonly>
          </div>
          <div class="mb-3">
            <label for="sessionDate" class="form-label">Session Date</label>
            <input type="date" class="form-control" id="sessionDate">
          </div>
          <div class="mb-3">
            <label class="form-label">1. CALL TO ORDER</label>
            
          </div>
          <div class="mb-3">
            <label class="form-label">2. INVOCATION</label>
            
          </div>
          <div class="mb-3">
            <label class="form-label">3. NATIONAL ANTHEM</label>
            
          </div>
          <div class="mb-3">
            <label class="form-label">4. SUGBO HYMN</label>
            
          </div>
          <div class="mb-3">
            <label class="form-label">5. ROLL CALL</label>
           
          </div>
          
          <!-- Section 6 with dynamic subsections -->
          <div class="mb-3">
            <label class="form-label">6. ADOPTION OF MINUTES OF THE PREVIOUS SESSION</label>
            <div id="adoptionMinutesContainer">
              <div class="input-group mb-2">
                <span class="input-group-text">6.1</span>
                <textarea class="form-control" id="adoptionMinutes" rows="2"></textarea>
              </div>
            </div>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addSubsection('adoptionMinutesContainer', 6)">+ Add Subsection</button>
          </div>

          <!-- Section 7 with dynamic subsections -->
          <div class="mb-3">
            <label class="form-label">7. COMMUNICATIONS RECEIVED</label>
            <div id="communicationsContainer">
              <div class="input-group mb-2">
                <span class="input-group-text">7.1</span>
                <textarea class="form-control" id="communications" rows="2"></textarea>
              </div>
            </div>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addSubsection('communicationsContainer', 7)">+ Add Subsection</button>
          </div>

          <!-- Section 8 with dynamic subsections -->
          <div class="mb-3">
            <label class="form-label">8. COMMITTEE REPORT</label>
            <div id="committeeReportContainer">
              <div class="input-group mb-2">
                <span class="input-group-text">8.1</span>
                <textarea class="form-control" id="committeeReport" rows="2"></textarea>
              </div>
            </div>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addSubsection('committeeReportContainer', 8)">+ Add Subsection</button>
          </div>

          <!-- Section 9 with dynamic subsections -->
          <div class="mb-3">
            <label class="form-label">9. FIRST READING</label>
            <div id="firstReadingContainer">
              <div class="input-group mb-2">
                <span class="input-group-text">9.1</span>
                <textarea class="form-control" id="firstReading" rows="2"></textarea>
              </div>
            </div>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addSubsection('firstReadingContainer', 9)">+ Add Subsection</button>
          </div>

          <div class="mb-3">
            <label class="form-label">10. OTHER MATTERS</label>
            
          </div>
          <div class="mb-3">
            <label class="form-label">11. ADJOURNMENT</label>
            
          </div>

          <!-- Added Prepared By and Approved By fields -->
          <div class="mb-3">
            <label class="form-label">PREPARED BY:</label>
            <input type="text" class="form-control" id="preparedBy" placeholder="Enter name">
          </div>
         
          <div class="mb-3">
            <label class="form-label">APPROVED:</label>
            <input type="text" class="form-control" id="approvedBy" placeholder="Enter name">
          </div>

          <button class="btn btn-primary" onclick="saveNotice()">Save Notice</button>
         
        </div>
      </div>

      <!-- Notices List -->
      <div class="card">
        <div class="card-body">
          <h4>Saved Notices</h4>
          <div id="noticesList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Notice Modal -->
  <div class="modal fade" id="editNoticeModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Notice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editNoticeId">
          <div class="mb-3">
            <label for="editMinutesNo" class="form-label">Minutes No.</label>
            <input type="text" class="form-control" id="editMinutesNo">
          </div>
          <div class="mb-3">
            <label for="editSessionDate" class="form-label">Session Date</label>
            <input type="date" class="form-control" id="editSessionDate">
          </div>
          <div class="mb-3">
            <label class="form-label">1. CALL TO ORDER</label>
           
          </div>
          <div class="mb-3">
            <label class="form-label">2. INVOCATION</label>
            
          </div>
          <div class="mb-3">
            <label class="form-label">3. NATIONAL ANTHEM</label>
            
          </div>
          <div class="mb-3">
            <label class="form-label">4. SUGBO HYMN</label>
            
          </div>
          <div class="mb-3">
            <label class="form-label">5. ROLL CALL</label>
           
          </div>
          <div class="mb-3">
            <label class="form-label">6. ADOPTION OF MINUTES OF THE PREVIOUS SESSION</label>
            <div id="editAdoptionMinutesContainer">
              <!-- Container will be populated dynamically -->
            </div>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addSubsection('editAdoptionMinutesContainer', 6)">+ Add Subsection</button>
          </div>
          <div class="mb-3">
            <label class="form-label">7. COMMUNICATIONS RECEIVED</label>
            <div id="editCommunicationsContainer">
              <!-- Container will be populated dynamically -->
            </div>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addSubsection('editCommunicationsContainer', 7)">+ Add Subsection</button>
          </div>
          <div class="mb-3">
            <label class="form-label">8. COMMITTEE REPORT</label>
            <div id="editCommitteeReportContainer">
              <!-- Container will be populated dynamically -->
            </div>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addSubsection('editCommitteeReportContainer', 8)">+ Add Subsection</button>
          </div>
          <div class="mb-3">
            <label class="form-label">9. FIRST READING</label>
            <div id="editFirstReadingContainer">
              <!-- Container will be populated dynamically -->
            </div>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addSubsection('editFirstReadingContainer', 9)">+ Add Subsection</button>
          </div>
          <div class="mb-3">
            <label class="form-label">10. OTHER MATTERS</label>
          
          </div>
          <div class="mb-3">
            <label class="form-label">11. ADJOURNMENT</label>
           
          </div>
          <!-- Added edit fields for Prepared By and Approved By -->
          <div class="mb-3">
            <label class="form-label">PREPARED BY:</label>
            <input type="text" class="form-control" id="editPreparedBy">
          </div>
        
          <div class="mb-3">
            <label class="form-label">APPROVED:</label>
            <input type="text" class="form-control" id="editApprovedBy">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="updateNotice()">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SMTP.js library -->
  <script src="https://smtpjs.com/v3/smtp.js"></script>
  
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.9.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.9.1/firebase-database-compat.js"></script>

  <!-- html2pdf library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- html2canvas library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- jsPDF library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    window.jsPDF = window.jspdf.jsPDF;
  </script>

  <!-- JavaScript -->
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAMwvUHsWFkTmJyfzuh4DxzOrMYEjcXHvI",
      authDomain: "lgucapstoneproject-b94fe.firebaseapp.com", 
      databaseURL: "https://lgucapstoneproject-b94fe-default-rtdb.firebaseio.com",
      projectId: "lgucapstoneproject-b94fe",
      storageBucket: "lgucapstoneproject-b94fe.appspot.com",
      messagingSenderId: "984934888272",
      appId: "1:984934888272:web:e835b8e02ae708629a7255",
      measurementId: "G-F84YQS756S"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Function to get the last minutes number and increment it
    function fetchAndSetMinutesNumber() {
      const minutesRef = db.ref('notices');

      // Query to get the last minutes number
      minutesRef.orderByChild('minutesNo').limitToLast(1).once('value', (snapshot) => {
        let newMinutesNo = 1;

        if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
            const lastMinutesNo = childSnapshot.val().minutesNo;
            console.log('Fetched lastMinutesNo:', lastMinutesNo);
            
            if (!isNaN(lastMinutesNo)) {
              newMinutesNo = parseInt(lastMinutesNo, 10) + 1;
            } else {
              console.error('Invalid minutesNo:', lastMinutesNo);
            }
          });
        }

        document.getElementById('minutesNo').value = newMinutesNo;
      }).catch((error) => {
        console.error('Error fetching the last minutes number:', error);
      });
    }

    // Call fetchAndSetMinutesNumber when page loads
    document.addEventListener('DOMContentLoaded', fetchAndSetMinutesNumber);
 


    // Function to add subsection
    function addSubsection(containerId, sectionNumber) {
      const container = document.getElementById(containerId);
      const subsectionCount = container.children.length + 1;
      const newSubsection = document.createElement('div');
      newSubsection.className = 'input-group mb-2';
      newSubsection.innerHTML = `
        <span class="input-group-text">${sectionNumber}.${subsectionCount}</span>
        <textarea class="form-control" rows="2"></textarea>
        <button class="btn btn-outline-danger" type="button" onclick="removeSubsection(this, '${containerId}', ${sectionNumber})">Remove</button>
      `;
      container.appendChild(newSubsection);
      updateSubsectionNumbers(containerId, sectionNumber);
    }

    // Function to remove subsection and update numbers
    function removeSubsection(button, containerId, sectionNumber) {
      button.parentElement.remove();
      updateSubsectionNumbers(containerId, sectionNumber);
    }

    // Function to update subsection numbers
    function updateSubsectionNumbers(containerId, sectionNumber) {
      const container = document.getElementById(containerId);
      const subsections = container.children;
      for(let i = 0; i < subsections.length; i++) {
        const numberSpan = subsections[i].querySelector('.input-group-text');
        numberSpan.textContent = `${sectionNumber}.${i + 1}`;
      }
    }

    // Retrieve user name from localStorage
    const userName = localStorage.getItem('userName');
    if (userName) {
      document.getElementById('welcomeMessage').textContent = `Admin: ${userName}`;
    }

    // Function to get subsection contents
    function getSubsectionContents(containerId) {
      const container = document.getElementById(containerId);
      const subsections = container.children;
      const contents = [];
      for(let i = 0; i < subsections.length; i++) {
        const textarea = subsections[i].querySelector('textarea');
        contents.push(textarea.value);
      }
      return contents;
    }

    // Save notice to Firebase
    function saveNotice() {
      const minutesNo = document.getElementById('minutesNo').value;
      const sessionDate = document.getElementById('sessionDate').value;
     
      
      // Get subsection contents
      const adoptionMinutesSubsections = getSubsectionContents('adoptionMinutesContainer');
      const communicationsSubsections = getSubsectionContents('communicationsContainer');
      const committeeReportSubsections = getSubsectionContents('committeeReportContainer');
      const firstReadingSubsections = getSubsectionContents('firstReadingContainer');
      
      
      const preparedBy = document.getElementById('preparedBy').value;
      const approvedBy = document.getElementById('approvedBy').value;
      const timestamp = new Date().toISOString();

      if (!minutesNo || !sessionDate) {
        alert('Please fill in Minutes No. and Session Date');
        return;
      }

      db.ref('notices').push({
        minutesNo: parseInt(minutesNo, 10),
        sessionDate,
        
        adoptionMinutesSubsections,
        communicationsSubsections,
        committeeReportSubsections,
        firstReadingSubsections,
       
        preparedBy,
        approvedBy,
        timestamp
      }).then(() => {
        // Clear form
        document.getElementById('minutesNo').value = '';
        document.getElementById('sessionDate').value = '';
        
        
        // Clear subsection containers
        document.getElementById('adoptionMinutesContainer').innerHTML = `
          <div class="input-group mb-2">
            <span class="input-group-text">6.1</span>
            <textarea class="form-control" id="adoptionMinutes" rows="2"></textarea>
          </div>
        `;
        document.getElementById('communicationsContainer').innerHTML = `
          <div class="input-group mb-2">
            <span class="input-group-text">7.1</span>
            <textarea class="form-control" id="communications" rows="2"></textarea>
          </div>
        `;
        document.getElementById('committeeReportContainer').innerHTML = `
          <div class="input-group mb-2">
            <span class="input-group-text">8.1</span>
            <textarea class="form-control" id="committeeReport" rows="2"></textarea>
          </div>
        `;
        document.getElementById('firstReadingContainer').innerHTML = `
          <div class="input-group mb-2">
            <span class="input-group-text">9.1</span>
            <textarea class="form-control" id="firstReading" rows="2"></textarea>
          </div>
        `;
        
        
        document.getElementById('preparedBy').value = '';
        document.getElementById('approvedBy').value = '';
      });
    }

    // Delete notice
    function deleteNotice(noticeId) {
      if (confirm('Are you sure you want to delete this notice?')) {
        db.ref('notices/' + noticeId).remove();
      }
    }

    // Open edit modal with notice data
    function openEditModal(noticeId, notice) {
      document.getElementById('editNoticeId').value = noticeId;
      document.getElementById('editMinutesNo').value = notice.minutesNo;
      document.getElementById('editSessionDate').value = notice.sessionDate;
      

      // Handle subsections by splitting data and creating new fields as needed
      function populateSubsections(containerId, data, prefix) {
        const container = document.getElementById(containerId);
        container.innerHTML = ''; // Clear existing content
        
        if (!data) return;
        
        // Handle both string and non-string data
        let subsections = [];
        if (typeof data === 'string') {
          subsections = data.split('\n').filter(item => item.trim());
        } else if (Array.isArray(data)) {
          subsections = data.filter(item => item && item.trim());
        } else {
          // If data is neither string nor array, treat as single item
          subsections = [data.toString()];
        }
        
        subsections.forEach((content, index) => {
          const div = document.createElement('div');
          div.className = 'input-group mb-2';
          div.innerHTML = `
            <span class="input-group-text">${prefix}.${index + 1}</span>
            <textarea class="form-control" rows="2">${content}</textarea>
            ${index === subsections.length - 1 ? 
              `<button type="button" class="btn btn-primary" onclick="addSubsection('${containerId}', '${prefix}')">+</button>` : 
              `<button type="button" class="btn btn-danger" onclick="removeSubsection(this)">-</button>`}
          `;
          container.appendChild(div);
        });

        // If no data, add one empty field
        if (subsections.length === 0) {
          const div = document.createElement('div');
          div.className = 'input-group mb-2';
          div.innerHTML = `
            <span class="input-group-text">${prefix}.1</span>
            <textarea class="form-control" rows="2"></textarea>
            <button type="button" class="btn btn-primary" onclick="addSubsection('${containerId}', '${prefix}')">+</button>
          `;
          container.appendChild(div);
        }
      }

      // Populate each subsection container
      populateSubsections('editAdoptionMinutesContainer', notice.adoptionMinutesSubsections, '6');
      populateSubsections('editCommunicationsContainer', notice.communicationsSubsections, '7');
      populateSubsections('editCommitteeReportContainer', notice.committeeReportSubsections, '8');
      populateSubsections('editFirstReadingContainer', notice.firstReadingSubsections, '9');

      
      document.getElementById('editPreparedBy').value = notice.preparedBy || '';
      document.getElementById('editApprovedBy').value = notice.approvedBy || '';
      
      const editModal = new bootstrap.Modal(document.getElementById('editNoticeModal'));
      editModal.show();
    }

    // Update notice
    function updateNotice() {
      const noticeId = document.getElementById('editNoticeId').value;
      // Get subsection contents from edit modal
      const adoptionMinutesSubsections = getSubsectionContents('editAdoptionMinutesContainer');
      const communicationsSubsections = getSubsectionContents('editCommunicationsContainer'); 
      const committeeReportSubsections = getSubsectionContents('editCommitteeReportContainer');
      const firstReadingSubsections = getSubsectionContents('editFirstReadingContainer');

      const updatedNotice = {
        minutesNo: document.getElementById('editMinutesNo').value,
        sessionDate: document.getElementById('editSessionDate').value,
        
        adoptionMinutesSubsections,
        communicationsSubsections,
        committeeReportSubsections,
        firstReadingSubsections,
        
        preparedBy: document.getElementById('editPreparedBy').value,
        approvedBy: document.getElementById('editApprovedBy').value
      };

      db.ref('notices/' + noticeId).update(updatedNotice).then(() => {
        const editModal = bootstrap.Modal.getInstance(document.getElementById('editNoticeModal'));
        editModal.hide();
      });
    }
  
    
    // Load and display notices
    function loadNotices() {
      const noticesContainer = document.getElementById('noticesList');
      
      // Remove any existing listeners before adding a new one
      db.ref('notices').off();
      
      db.ref('notices').on('value', (snapshot) => {
        noticesContainer.innerHTML = ''; // Clear existing notices
        
        const notices = snapshot.val();
        if (notices) {
          Object.keys(notices).forEach((noticeId) => {
            const notice = notices[noticeId];
            const noticeCard = document.createElement('div');
            noticeCard.className = 'card mb-3';
            noticeCard.innerHTML = `
              <div class="card-body">
                <h5 class="card-title">Notice No: ${notice.minutesNo}</h5>
                <h6 class="card-subtitle mb-2 text-muted">Session Date: ${notice.sessionDate}</h6>
                <div class="mt-3">
                  <button class="btn btn-primary btn-sm me-2" onclick="printNotice('${noticeId}')">Print</button>
                  <button class="btn btn-success btn-sm me-2" onclick="downloadPDF('${noticeId}')">Download PDF</button>
                  <button class="btn btn-info btn-sm me-2" onclick="sendEmailToOfficials('${noticeId}')">Send to Officials</button>
                  <button class="btn btn-warning btn-sm me-2" onclick="openEditModal('${noticeId}', ${JSON.stringify(notice).replace(/"/g, '&quot;')})">Edit</button>
                  <button class="btn btn-danger btn-sm" onclick="deleteNotice('${noticeId}')">Delete</button>
                </div>
              </div>
            `;
            noticesContainer.appendChild(noticeCard);
          });
        }
      });
    }

    // Function to send email to officials
    function sendEmailToOfficials(noticeId) {
    // Confirm action
    if (!confirm("Are you sure you want to send emails to all officials?")) {
        return;
    }

    // Show loading indicator
    const noticesList = document.getElementById('noticesList');
    const loadingIndicator = document.createElement('div');
    loadingIndicator.className = 'alert alert-info';
    loadingIndicator.textContent = 'Sending emails...';
    noticesList.prepend(loadingIndicator);

    // Get the notice data from Firebase
    db.ref(`notices/${noticeId}`).once('value')
        .then(snapshot => {
            const noticeData = snapshot.val();
            if (!noticeData) {
                throw new Error('Notice data not found.');
            }

            // Send the AJAX request with notice data
            return fetch('/send_email_to_officials/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') // Include CSRF token
                },
                body: JSON.stringify({ notice_id: noticeId })
            });
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.message || `HTTP error! Status: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            // Success response
            loadingIndicator.className = 'alert alert-success';
            loadingIndicator.textContent = data.message || 'Emails sent successfully.';
            setTimeout(() => loadingIndicator.remove(), 5000);
        })
        .catch(error => {
            // Handle errors
            console.error('Error:', error);
            loadingIndicator.className = 'alert alert-danger';
            loadingIndicator.textContent = error.message || 'An error occurred while sending emails. Please try again.';
            setTimeout(() => loadingIndicator.remove(), 5000);
        });
}

// Function to get the CSRF token
function getCookie(name) {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(`${name}=`)) {
            return decodeURIComponent(cookie.substring(name.length + 1));
        }
    }
    return null;
}



    // Print notice with subsections
    function printNotice(noticeId) {
      db.ref('notices/' + noticeId).once('value').then((snapshot) => {
        const notice = snapshot.val();

          const printWindow = window.open('', '', 'width=800,height=600');
          
          let adoptionMinutesHtml = '';
          if (notice.adoptionMinutesSubsections) {
            notice.adoptionMinutesSubsections.forEach((content, index) => {
              adoptionMinutesHtml += `<div>6.${index + 1} ${content}</div>`;
            });
          }

          let communicationsHtml = '';
          if (notice.communicationsSubsections) {
            notice.communicationsSubsections.forEach((content, index) => {
              communicationsHtml += `<div>7.${index + 1} ${content}</div>`;
            });
          }

          let committeeReportHtml = '';
          if (notice.committeeReportSubsections) {
            notice.committeeReportSubsections.forEach((content, index) => {
              committeeReportHtml += `<div>8.${index + 1} ${content}</div>`;
            });
          }

          let firstReadingHtml = '';
          if (notice.firstReadingSubsections) {
            notice.firstReadingSubsections.forEach((content, index) => {
              firstReadingHtml += `<div>9.${index + 1} ${content}</div>`;
            });
          }

          printWindow.document.write(`
            <html>
              <head>
                <title>Session Notice</title>
                <style>
                  body { 
                    font-family: Times New Roman, sans-serif;
                    padding: 20px;
                    max-width: 800px;
                    margin: 0 auto;
                  }
                  .header {
                    text-align: center;
                    margin-bottom: 40px;
                    position: relative;
                  }
                  .logo-left {
                    position: absolute;
                    left: 0;
                    top: 0;
                    width: 100px;
                  }
                  .logo-right {
                    position: absolute;
                    right: 0;
                    top: 0;
                    width: 100px;
                  }
                  .letterhead-text {
                    font-size: 12px;
                    line-height: 1.5;
                    margin: 0;
                    text-transform: uppercase;
                    font-weight: bold;
                  }
                  .title {
                    text-align: center;
                    font-size: 16px;
                    font-weight: bold;
                    text-transform: uppercase;
                  }
                  .content {
                    font-size: 14px;
                    line-height: 1.6;
                    text-align: justify;
                    margin-top: 30px;
                  }
                  .session-info {
                    text-align: center;
                    margin: 20px 0;
                    font-size: 14px;
                  }
                  .agenda-item {
                    margin: 15px 0;
                  }
                  .agenda-label {
                    font-weight: bold;
                  }
                  .signatures {
                    margin-top: 50px;
                    display: flex;
                    justify-content: flex-end;
                    gap: 20px;
                  }
                  .signature-block {
                    text-align: center;
                    width: 45%;
                  }
                  .signature-line {
                    margin: 10px 0;
                  }
                  .signature-title {
                    font-size: 12px;
                    font-style: italic;
                  }
                </style>
              </head>
              <body>
                <div class="header">
                <div style="margin: 15px 0;">
                  <img src="{% static 'argao_logo.jpg' %}" alt="Left Logo" class="logo-left">
                  <img src="{% static 'basers101.png' %}" alt="Right Logo" class="logo-right">
                  <p class="letterhead-text">Republic of the Philippines</p>
                  <p class="letterhead-text">Province of Cebu</p>
                  <p class="letterhead-text">Municipality of Argao</p>
                  <p class="letterhead-text">OFFICE OF THE SANGGUNIANG BAYAN</p>
                  <p class="letterhead-text">Tel. No.: (032) 367-7623</p>
                  <p class="letterhead-text">Email: sbargao@gmail.com</p>
                </div>
                  <h3>Order of Business</h3>
                  <h3>Regular Session</h3>
                  <p>(Minutes No: ${notice.minutesNo})</p>
                  <p>Date: ${notice.sessionDate}</p>
                  
                  
                </div>
                <div class="content">
                  <h4>1. CALL TO ORDER</h4>
                  <p>${notice.callToOrder || ''}</p>

                  <h4>2. INVOCATION</h4>
                  <p>${notice.invocation || ''}</p>

                  <h4>3. NATIONAL ANTHEM</h4>
                  <p>${notice.nationalAnthem || ''}</p>

                  <h4>4. SUGBO HYMN</h4>
                  <p>${notice.sugboHymn || ''}</p>

                  <h4>5. ROLL CALL</h4>
                  <p>${notice.rollCall || ''}</p>

                  <h4>6. ADOPTION OF MINUTES OF THE PREVIOUS SESSION</h4>
                  ${adoptionMinutesHtml}

                  <h4>7. COMMUNICATIONS RECEIVED</h4>
                  ${communicationsHtml}

                  <h4>8. COMMITTEE REPORT</h4>
                  ${committeeReportHtml}

                  <h4>9. FIRST READING</h4>
                  ${firstReadingHtml}

                  <h4>10. OTHER MATTERS</h4>
                  <p>${notice.otherMatters || ''}</p>

                  <h4>11. ADJOURNMENT</h4>
                  <p>${notice.adjournment || ''}</p>
                </div>
               

                <div class="signature-block" style="text-align: center; margin-left: 350px;">
                <p >${notice.preparedBy || ''}</p>
                    <p style="font-weight: bold;">Secretary to the Sangguniang Bayan</p>
                </div>
                
                <div class="signature-block" style="text-align: center; margin-left: 350px;">
                    <p>Approved:</p>
                    
                    <p>${notice.approvedBy || ''}</p>
                    <p style="font-weight: bold;">Municipal Vice Mayor & Presiding Officer</p>
                  </div>
              

              </body>
            </html>
          `);
          printWindow.document.close();
          printWindow.print();
        
      });
    }

    // Download PDF function
    function downloadPDF(noticeId) {
      db.ref('notices/' + noticeId).once('value').then((snapshot) => {
        const notice = snapshot.val();

        if (!notice) {
          console.error('No data found for the given noticeId:', noticeId);
          alert('Error: No data found for this notice.');
          return;
        }
          // Generate HTML content for subsections
          let adoptionMinutesHtml = '';
          if (Array.isArray(notice.adoptionMinutesSubsections)) {
            notice.adoptionMinutesSubsections.forEach((content, index) => {
              adoptionMinutesHtml += `<div>6.${index + 1} ${content}</div>`;
            });
          }

          let communicationsHtml = '';
          if (Array.isArray(notice.communicationsSubsections)) {
            notice.communicationsSubsections.forEach((content, index) => {
              communicationsHtml += `<div>7.${index + 1} ${content}</div>`;
            });
          }

          let committeeReportHtml = '';
          if (Array.isArray(notice.committeeReportSubsections)) {
            notice.committeeReportSubsections.forEach((content, index) => {
              committeeReportHtml += `<div>8.${index + 1} ${content}</div>`;
            });
          }

          let firstReadingHtml = '';
          if (Array.isArray(notice.firstReadingSubsections)) {
            notice.firstReadingSubsections.forEach((content, index) => {
              firstReadingHtml += `<div>9.${index + 1} ${content}</div>`;
            });
          }

          // Helper function to handle empty/null values
          const safeText = (text) => text || '';

          // Create temporary element
          const element = document.createElement('div');
          element.style.position = 'relative';
          element.style.margin = '0 auto';
          element.style.maxWidth = '8.5in';
          element.style.minHeight = '11in'; // Changed to minHeight to allow content to flow
          element.style.backgroundColor = 'white';
          element.style.boxShadow = '0 0 10px rgba(0,0,0,0.1)';
          element.style.width = '8.5in';
          element.style.padding = '0.5in';
          
          element.innerHTML = `
            <style>
              body { 
                font-family: Times New Roman, sans-serif;
                padding: 20px;
                max-width: 800px;
                margin: 0 auto;
                font-size: 14px; /* Increased base font size */
              }
              .header {
                text-align: center;
                margin-bottom: 20px;
                position: relative;
              }
              .logo-left {
                position: absolute;
                left: 0;
                top: 0;
                width: 100px; /* Increased logo size */
              }
              .logo-right {
                position: absolute;
                right: 0;
                top: 0;
                width: 100px; /* Increased logo size */
              }
              .letterhead-text {
                font-size: 14px; /* Increased font size */
                line-height: 1.2;
                margin: 0;
                
                font-weight: bold;
              }
              .title {
                text-align: center;
                font-size: 16px; /* Increased font size */
                font-weight: bold;
               
              }
              .content {
                font-size: 14px; /* Increased font size */
                line-height: 1.4;
                text-align: justify;
                margin-top: 15px;
              }
              .session-info {
                text-align: center;
                margin: 10px 0;
                font-size: 14px; /* Increased font size */
              }
              .agenda-item {
                margin: 8px 0;
              }
              .agenda-label {
                font-weight: bold;
              }
              .signatures {
                margin-top: 20px;
                display: flex;
                justify-content: flex-end;
                gap: 20px;
              }
              .signature-block {
                text-align: center;
                width: 45%;
              }
              .signature-line {
                margin: 5px 0;
              }
              .signature-title {
                font-size: 14px; /* Increased font size */
                font-style: italic;
              }
              p {
                margin: 5px 0;
                font-size: 14px; /* Increased font size */
              }
              div {
                margin-bottom: 10px;
              }
            </style>
            <div style="font-family: Times New Roman, sans-serif;">
              <div class="header">
                <div style="margin: 10px 0;">
                  <img src="{% static 'argao_logo.jpg' %}" alt="Left Logo" class="logo-left">
                  <img src="{% static 'basers101.png' %}" alt="Right Logo" class="logo-right">
                  <p class="letterhead-text">Republic of the Philippines</p>
                  <p class="letterhead-text">Province of Cebu</p>
                  <p class="letterhead-text">Municipality of Argao</p>
                  <p class="letterhead-text">OFFICE OF THE SANGGUNIANG BAYAN</p>
                  <p class="letterhead-text">Tel. No.: (032) 367-7623</p>
                  <p class="letterhead-text">Email: sbargao@gmail.com</p>
                </div>
                <h3>Order of Business</h3>
                <h3>Regular Session</h3>
                <p>(Minutes No: ${notice.minutesNo})</p>
                <p>Date: ${notice.sessionDate}</p>
              </div>
              
             
              
              <div style="margin-bottom: 10px;">
                <p style="font-weight: bold;">1. CALL TO ORDER</p>
                <p>${safeText(notice.callToOrder)}</p>
              </div>

              <div style="margin-bottom: 10px;">
                <p style="font-weight: bold;">2. INVOCATION</p>
                <p>${safeText(notice.invocation)}</p>
              </div>

              <div style="margin-bottom: 10px;">
                <p style="font-weight: bold;">3. NATIONAL ANTHEM</p>
                <p>${safeText(notice.nationalAnthem)}</p>
              </div>

              <div style="margin-bottom: 10px;">
                <p style="font-weight: bold;">4. SUGBO HYMN</p>
                <p>${safeText(notice.sugboHymn)}</p>
              </div>

              <div style="margin-bottom: 10px;">
                <p style="font-weight: bold;">5. ROLL CALL</p>
              
                <p>${safeText(notice.rollCall)}</p>
              </div>

              <div style="margin-bottom: 10px;">
                <p style="font-weight: bold;">6. ADOPTION OF MINUTES</p>
                ${adoptionMinutesHtml || '<p>No Adoption Minutes Available</p>'}
              </div>

              <div style="margin-bottom: 10px;">
                <p style="font-weight: bold;">7. COMMUNICATIONS</p>
                ${communicationsHtml || '<p>No Communications Available</p>'}
              </div>

              <div style="margin-bottom: 10px;">
                <p style="font-weight: bold;">8. COMMITTEE REPORT</p>
                ${committeeReportHtml || '<p>No Committee Reports Available</p>'}
              </div>

              <div style="margin-bottom: 10px;">
                <p style="font-weight: bold;">9. FIRST READING</p>
                ${firstReadingHtml || '<p>No First Readings Available</p>'}
              </div>

              <div style="margin-bottom: 10px;">
                <p style="font-weight: bold;">10. OTHER MATTERS</p>
                <p>${safeText(notice.otherMatters)}</p>
              </div>

              <div style="margin-bottom: 10px;">
                <p style="font-weight: bold;">11. ADJOURNMENT</p>
                <p>${safeText(notice.adjournment)}</p>
              </div>

             
                <div style="text-align: center; width: 45%; margin-left: 350px;">
                  <p style="margin-bottom: 2px;">${safeText(notice.preparedBy)}</p>
                  <p style="margin-top: 0; font-weight: bold;">Secretary to the Sangguniang Bayan</p>
                </div>
                
                <div style="text-align: center; width: 45%; margin-left: 350px;">
                  <p style="font-weight: bold;">Approved:</p>
                  <p style="margin-bottom: 2px;">${safeText(notice.approvedBy)}</p>
                  <p style="margin-top: 0; font-weight: bold;">Municipal Vice Mayor & Presiding Officer</p>
                </div>
             
            </div>
          `;

          // Add element to document body
          document.body.appendChild(element);

          // Use html2canvas to capture the element
          html2canvas(element, {
            scale: 2,
            useCORS: true,
            logging: true,
            height: element.offsetHeight,
            windowHeight: element.offsetHeight,
          }).then((canvas) => {
            const pdf = new jsPDF('p', 'pt', 'letter'); // Use 'pt' for more precise dimensions
            const imgData = canvas.toDataURL('image/png');

            const imgWidth = 612; // PDF width in points for a letter-sized page
            const pageHeight = 792; // PDF height in points for a letter-sized page
            const imgHeight = (canvas.height * imgWidth) / canvas.width; // Calculate image height maintaining aspect ratio
            let heightLeft = imgHeight; // Track how much of the image is left to render

            let position = 0; // Y-coordinate to start rendering on the page

            // Add the first page
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            // Add additional pages if content overflows
            while (heightLeft > 0) {
              position = heightLeft - imgHeight; // Calculate new position
                pdf.addPage(); // Add a new page
              pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
              heightLeft -= pageHeight;
            }

            pdf.save(`notice_${notice.minutesNo || 'default'}.pdf`);
              document.body.removeChild(element);
            console.log('Multi-page PDF generated successfully');
          }).catch((error) => {
              console.error('Error generating PDF:', error);
            document.body.removeChild(element);
          });

        
      }).catch(error => {
        console.error('Error retrieving notice data:', error);
      });
    }


    // Sidebar toggle function
    window.toggleSidebar = function() {
      const sidebar = document.querySelector('.sidebar');
      const burgerMenu = document.querySelector('.burger-menu');
      
      sidebar.classList.toggle('collapsed');
      
      if (sidebar.classList.contains('collapsed')) {
        // When collapsed, only show burger icon
        sidebar.style.width = '60px';
        burgerMenu.style.display = 'block';
      } else {
        // When expanded, show full sidebar
        sidebar.style.width = '250px';
        burgerMenu.style.display = 'none';
      }
    }

    // Handle window resize
    window.addEventListener('resize', function() {
      const sidebar = document.querySelector('.sidebar');
      if (window.innerWidth <= 768) {
        sidebar.classList.remove('collapsed');
        if (!sidebar.classList.contains('active')) {
          sidebar.style.transform = 'translateX(-250px)';
        }
      } else {
        sidebar.style.transform = '';
      }
    });

    // Load notices when page loads 
    window.onload = function() {
      loadNotices();
      fetchAndSetMinutesNumber();

    };
    window.logout = function() {
      localStorage.removeItem('userName');
      window.location.href = 'main_login';
    }
  </script>
</body>
</html>